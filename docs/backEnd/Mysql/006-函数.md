# 函数

## 分组函数

⚡️ **分组函数：**

- **对多行数据进行计算，返回一个结果值。**
- 常用于 **`GROUP BY`** 或统计分析。
- 作用：对一组数据进行汇总统计。

| 函数      | 作用       |
| --------- | ---------- |
| `COUNT()` | 统计行数   |
| `SUM()`   | 计算总和   |
| `AVG()`   | 计算平均值 |
| `MAX()`   | 求最大值   |
| `MIN()`   | 求最小值   |

使用示例：

```sql
-- 建表示例
CREATE TABLE sales (
    id INT,
    product VARCHAR(20),
    amount DECIMAL(10,2)
);

INSERT INTO sales VALUES
(1, '手机', 2000),
(2, '电脑', 5000),
(3, '手机', 3000),
(4, '平板', 2500);

-- 示例1: 求总销售额
SELECT SUM(amount) AS total_sales FROM sales;

-- 示例2: 求平均销售额
SELECT AVG(amount) AS avg_sales FROM sales;

-- 示例3: 按产品分组，统计销售数量 & 总额
SELECT product, COUNT(*) AS sales_count, SUM(amount) AS total
FROM sales
GROUP BY product;

```

```sql
-- 查询平均年龄，聚合函数（分组函数）把多条数组聚合成一条数据
select avg(employee.empage) as "平均年龄" from employee;

-- 统计求和
select sum(employee.empscore) as "绩效总和" from employee;

-- 统计最大的年龄
select max(employee.empage) from employee;

-- 统计最小的年龄
select min(employee.empage) from employee;

-- 统计记录数
-- 统计员工表中总共有多少条记录数，以下两个作用相同
select count(*) as "总记录数" from employee;
select count(1) as "总记录数" from employee;
```

## 单行函数

- **作用于每一行，返回一个结果。**
- 不改变数据的行数。
- 常用于查询结果的格式化、数据处理。

### 数值函数

| 函数          | 作用            |
| ------------- | --------------- |
| `ABS(x)`      | 绝对值          |
| `ROUND(x, d)` | 四舍五入到 d 位 |
| `FLOOR(x)`    | 向下取整        |
| `CEIL(x)`     | 向上取整        |
| `MOD(x,y)`    | 取余            |

```sql
-- 求绝对值
select abs(-123);

-- 四舍五入
select round(3.3);

-- 向下取整
select floor(3.3);

-- 向上取整
select ceil(3.3);

-- 取余
select mod(10,3);

```

### 字符串函数

| 函数                             | 作用                     |
| -------------------------------- | ------------------------ |
| `LENGTH(str)`                    | 返回字符串长度（字符数） |
| `CONCAT(a,b,...)`                | 拼接字符串               |
| `UPPER(str)` / `LOWER(str)`      | 大小写转换               |
| `TRIM(str)`                      | 去掉前后空格             |
| `SUBSTRING(str,pos,len)`         | 截取字符串               |
| `REPLACE(str, from_str, to_str)` | 替换字符串               |

🔖 使用示例：

```sql
-- 字符串长度
select length('Hello World');

-- 拼接
select concat('Hello',' ','SQL');

-- 转大写
select upper('hello');

-- 去掉前后空格
select trim('   SQL   ');

-- 截取字符串
select substring('abcdef', 2, 3);

-- 替换
select replace('hello world','world','SQL');

```

### 日期函数

| 函数                                     | 作用             |
| ---------------------------------------- | ---------------- |
| `NOW()`                                  | 返回当前日期时间 |
| `CURDATE()` / `CURTIME()`                | 当前日期 / 时间  |
| `YEAR(date)`、`MONTH(date)`、`DAY(date)` | 提取年、月、日   |
| `DATE_ADD(date, INTERVAL n unit)`        | 日期加减         |
| `DATEDIFF(d1,d2)`                        | 日期差（天数）   |

🔖 使用示例：

```sql
-- 当前日期时间
select now();

-- 只取日期
select curdate();

-- 提取年、月、日
select year(now()), month(now()), day(now());

-- 日期加减
select date_add('2025-08-19', interval 7 day);

-- 日期差
select datediff('2025-08-19','2025-08-01');

```

### 系统信息函数

| 函数               | 作用                  |
| ------------------ | --------------------- |
| `USER()`           | 当前用户              |
| `DATABASE()`       | 当前数据库            |
| `VERSION()`        | 数据库版本            |
| `LAST_INSERT_ID()` | 最近一次插入的自增 ID |

🔖 使用示例：

```sql
-- 当前用户
select user();

-- 当前数据库
select database();

-- MySQL 版本
select version();

-- 最近一次插入 ID
insert into test(name) values('abc');
select last_insert_id();

```

### 条件判断函数

| 函数                                  | 作用                     |
| ------------------------------------- | ------------------------ |
| `IF(expr, v1, v2)`                    | 条件成立返回 v1，否则 v2 |
| `IFNULL(v1, v2)`                      | v1 为 NULL 时返回 v2     |
| `CASE WHEN ... THEN ... ELSE ... END` | 多条件判断               |

🔖 使用示例：

```sql
-- IF 判断
select if(10>5, '大于', '小于');

-- IFNULL
select ifnull(null, '默认值');

-- CASE，使用方式1：条件是一个区间
select 
  case 
    when score >= 90 then '优秀'
    when score >= 60 then '及格'
    else '不及格'
  end as result
from exam;


-- CASE，使用方式2：条件是常量
select 
  case 
    when 100 then '满分'
    when 60 then '及格'
    else '不及格'
  end as result
from exam;

```

### 其他函数

| 函数       | 作用           |
| ---------- | -------------- |
| `UUID()`   | 生成唯一标识符 |
| `MD5(str)` | 计算 MD5 值    |
| `RAND()`   | 生成随机数     |

🔖 使用示例：

```sql
-- UUID
select uuid();

-- MD5
select md5('123456');

-- 随机数
select rand();

```

### 窗口函数

（Mysql 8.0新特性）

| 函数                         | 作用                       |
| ---------------------------- | -------------------------- |
| `ROW_NUMBER()`               | 行号                       |
| `RANK()`                     | 排名（有并列，跳过名次）   |
| `DENSE_RANK()`               | 排名（有并列，不跳过名次） |
| `SUM()/AVG()/COUNT() OVER()` | 窗口聚合                   |
| `RANK() OVER(...)`           | 给结果集中的每一行分配排名 |

🔖 使用示例：

```sql
-- 按成绩排名
select 
  name, score,
  row_number() over(order by score desc) as rownum,
  rank() over(order by score desc) as ranknum,
  dense_rank() over(order by score desc) as denserank
from exam;

-- 分组内求平均
select 
  dept, name, salary,
  avg(salary) over(partition by dept) as avg_salary
from employee;

```

```sql
-- RANK() OVER(...) 窗口函数示例

SELECT dept, name, salary,
       RANK() OVER(PARTITION BY dept ORDER BY salary DESC) AS rnk
FROM employee
```

### 加密函数

| 函数                    | 作用                                              |
| ----------------------- | ------------------------------------------------- |
| `MD5(str)`              | 返回字符串的 MD5 128 位哈希值（32位16进制字符串） |
| `SHA(str)`              | 返回字符串的 SHA1 哈希值                          |
| `SHA2(str, len)`        | 使用 SHA2 算法加密，len=224/256/384/512           |
| `PASSWORD(str)`         | 返回 MySQL 内部使用的加密串（不推荐用户自行使用） |
| `ENCODE(str, key)`      | 使用 key 对 str 进行加密                          |
| `DECODE(str, key)`      | 使用 key 对加密串进行解密                         |
| `AES_ENCRYPT(str, key)` | 使用 AES 算法加密                                 |
| `AES_DECRYPT(str, key)` | 使用 AES 算法解密                                 |

🔖 使用示例：

```sql
-- 使用 MD5 加密
select md5('123456') as md5_pwd;

-- 使用 SHA1 加密
select sha('hello world') as sha1_val;

-- 使用 SHA2 加密（256位），生成的长度为 256/4 = 64位的字符串
select sha2('hello world', 256) as sha2_val;

-- 使用 AES 加密和解密
select 
  aes_encrypt('secret_data', 'mykey') as encrypted,
  aes_decrypt(aes_encrypt('secret_data', 'mykey'), 'mykey') as decrypted;

-- 使用 ENCODE/DECODE
select 
  encode('testdata','mykey') as encoded,
  decode(encode('testdata','mykey'),'mykey') as decoded;

```

总结：

- **分组函数**：对多行做统计（SUM、COUNT、AVG…）。
- **单行函数**：对单行做处理（ABS、SUBSTRING、NOW…）。